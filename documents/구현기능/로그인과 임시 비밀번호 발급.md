## ë¡œê·¸ì¸ê³¼ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ë°œê¸‰  

ì›¹ì‚¬ì´íŠ¸ì˜ ê¸°ë³¸ ê¸°ëŠ¥ì¸ ë¡œê·¸ì¸ ê¸°ëŠ¥ê³¼  
ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠì€ ì‚¬ìš©ìë¥¼ ìœ„í•œ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ë°œê¸‰ ê¸°ëŠ¥ì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤  
<br/>

ëª©ì°¨

- [â–¶ï¸íšŒì› ë¡œê·¸ì¸]
- [âœ…ë¡œê·¸ì¸ í¼ ìœ íš¨ì„± ê²€ì¦]
- [ğŸ”‘ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ë°œê¸‰ê³¼ ë©”ì¼ ì „ì†¡]
- [ğŸ“¡ajaxë¥¼ ì´ìš©í•´ DB ì¡°íšŒ ê²°ê³¼ ë°˜í™˜ë°›ê¸°]

<br/>
<br/>

### â–¶ï¸íšŒì› ë¡œê·¸ì¸  
![2021-06-30 22 59 23](https://user-images.githubusercontent.com/80666066/123974554-a434b800-d9f7-11eb-8bd7-c464431742f0.gif)
ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸ì„ í•˜ë©´ íšŒì›ë§Œ ì´ìš©í•  ìˆ˜ ìˆëŠ” ëª¨ë‘ì–´ë¦¬ ë‚´ë¶€ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤  
ì´ë©”ì¼ë¡œ íšŒì› ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•´ì„œ ì…ë ¥ëœ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ëŠ” ì§€ í™•ì¸í•˜ê³ ,  
ì¼ì¹˜í•˜ëŠ” ê²½ìš° ì„¸ì…˜ì— í˜„ì¬ ì‚¬ìš©ì íšŒì›ì˜ pkê°’ì„ ë‹´ê³  ë‚´ë¶€ ë©”ì¸í˜ì´ì§€ë¡œ ì´ë™ì‹œí‚µë‹ˆë‹¤  
ì¼ì¹˜í•˜ì§€ ì•Šì„ ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë˜ëŒë ¤ë³´ëƒ…ë‹ˆë‹¤  
<br/>

```java
@Controller
@RequiredArgsConstructor
public class MainController {

    @PostMapping("/login")
    public String memberLogin(@Valid LoginForm form, BindingResult result, HttpSession session) {
    
        if (memberService.memberLogin(form.getEmail(), form.getPassword())) {
            Member member = memberService.findOneByEmail(form.getEmail());
            session.setAttribute("memberId", member.getId());
            return "redirect:/diary";
        } else {
            return "redirect:/";
        }
    }
}
```
<br/>
ì•„ë˜ëŠ” ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” memberLogin ë©”ì†Œë“œì˜ ì½”ë“œì™€ ì¿¼ë¦¬ë¬¸ì…ë‹ˆë‹¤  
<br/>

```java
@Service
@Transactional(readOnly = true)
public class MemberService {
    //ë¡œê·¸ì¸ ì²˜ë¦¬ë¥¼ ìœ„í•´ ì´ë©”ì¼ë¡œ ê²€ìƒ‰ í›„ ë¹„ë°€ë²ˆí˜¸ ê°’ ë¹„êµ
    public boolean memberLogin(String email, String password) {
        boolean result = false;

        try{
            Member member = memberRepository.findOneByEmail(email);
            if(member.getPassword().equals(password)) {
              result = true;
            }
        }catch (NoResultException e){
        }finally {
            return result;
        }
    }
}
```

<br/>

```java
@Repository
@RequiredArgsConstructor
public class MemberRepository {
    //ë‹¨ì¼ ì´ë©”ì¼ë¡œ ì¡°íšŒ
    public Member findOneByEmail(String email) throws NoResultException{
        return em.createQuery("select m from Member m" +
                " where m.email = :email", Member.class)
                .setParameter("email", email)
                .getSingleResult();
    }
}
```
  
<br/>
<hr>
<br/><br/>  

### âœ…ë¡œê·¸ì¸ í¼ ìœ íš¨ì„± ê²€ì¦  

<img width="633" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2021-06-30 á„‹á…©á„’á…® 11 00 24" src="https://user-images.githubusercontent.com/80666066/123976362-09d57400-d9f9-11eb-8faf-39e8d186c4d9.png">
<img width="636" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2021-06-30 á„‹á…©á„’á…® 11 00 35" src="https://user-images.githubusercontent.com/80666066/123976375-0cd06480-d9f9-11eb-8527-653f50324ae9.png">

javascript ì½”ë“œë¡œ booleaní˜•ì„ ë°˜í™˜í•˜ëŠ” ë¡œê·¸ì¸ í¼ì˜ ìœ íš¨ì„± ê²€ì¦ì„ ì‘ì„±í•˜ê³  onsubmit ì´ë²¤íŠ¸ì— ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤  
ê³µë€ì´ ìˆê±°ë‚˜ ì´ë©”ì¼ ì–‘ì‹ì´ í‹€ë ¸ë‹¤ë©´ ì‚¬ìš©ìì—ê²Œ ì•Œë ¤ì£¼ê³  ì„œë²„ë‹¨ ì „ì†¡ì„ ì‹œí–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤  

```html
<div class="login-wrap">
  <div class="login-form">
    <form role="form" action="/login" onsubmit="return checkLoginForm();" method="post">
    <!-- ì…ë ¥ ì–‘ì‹ ë¶€ë¶„ ìƒëµ -->
    </form>
  </div>
</div>
```

<br/>

```javascript
//ë¡œê·¸ì¸ ì…ë ¥ê°’ ìœ íš¨ì„± ê²€ì¦
function checkLoginForm() {

    //ì´ì „ ê²€ì¦ í›„ í‘œì‹œëœ ì—ëŸ¬ ë¬¸êµ¬ë¥¼ ì¼ê´„ ì‚­ì œ
    eraseErrors();
    let result = true;

    //ì´ë©”ì¼ í˜•ì‹ í™•ì¸
    if(!checkEmail('email-error', document.getElementById('email').value)){
        result = false;
    }

    //ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸ ì¹¸ì´ ë¹„ì—ˆëŠ”ì§€ í™•ì¸
    if(!checkBlank('email', 'ì´ë©”ì¼ì„')){
        result = false;
    }

    if(!checkBlank('password', 'ë¹„ë°€ë²ˆí˜¸ë¥¼')) {
        result = false;
    }

    return result;
}

//ì •ê·œì‹ìœ¼ë¡œ ì´ë©”ì¼ í™•ì¸
function checkEmail(errorSpan, email) {
    let emailRegExp = /^[A-Za-z0-9_]+[A-Za-z0-9]*[@][A-Za-z0-9]+[A-Za-z0-9]*[.][A-Za-z]{1,3}$/;
    if(!emailRegExp.test(email)) {
        document.getElementById(errorSpan).innerHTML = 'ì˜¬ë°”ë¥¸ ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”';
        document.getElementById(errorSpan).style.display = 'inline';
        return false;
    }
    return true;
}

//í•´ë‹¹ ì¹¸ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
function checkBlank(id, name) {
    let str = document.getElementById(id).value;
    if(str.length == 0){
        document.getElementById(id + '-error').innerHTML = name + ' ì…ë ¥í•˜ì„¸ìš”';
        document.getElementById(id + '-error').style.display = 'inline';
        return false;
    }
    return true;
}

```  

<br/>
<hr>
<br/><br/>

### ğŸ”‘ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ë°œê¸‰ê³¼ ë©”ì¼ ì „ì†¡  

ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠì€ íšŒì›ì„ ìœ„í•´ ë‚œìˆ˜ë¡œ ìƒì„±í•œ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°œê¸‰í•˜ê³  ë©”ì¼ë¡œ ë³´ë‚´ì£¼ëŠ” ê¸°ëŠ¥ì„ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤  
ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ë°œê¸‰ í¼ì„ ì œì¶œí•˜ë©´, íšŒì›ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¬ì„¤ì • í•œ í›„ ë©”ì¼ë¡œ ë³´ëƒ…ë‹ˆë‹¤  
<br/>

```java
@Controller
public class MemberController {
    
    //ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
    @PostMapping("/reset-password")
    public String resetPassword(HttpServletRequest request){
    
        //ì´ë©”ì¼ë¡œ ë©¤ë²„ ì¡°íšŒ
        String email = request.getParameter("reset-password-email");
        Member member = memberService.findOneByEmail(email);

        //ë¹„ë°€ë²ˆí˜¸ë¥¼ ëœë¤ ìˆ«ì 6ìë¦¬ë¡œ ë³€ê²½
        memberService.resetPassword(member);

        HttpSession session = request.getSession();

        //ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ë¥¼ í¬í•¨í•œ ë©”ì¼ ë³´ë‚´ê¸°
        try {
            emailUtil.sendResetPasswordMail(member);
            session.setAttribute("passwordAlert", "success");
        } catch (MessagingException | UnsupportedEncodingException e) {
            session.setAttribute("passwordAlert", "fail");
            e.printStackTrace();
        }

        return "redirect:/";
    }
}
```
<br/>
ì´ë©”ì¼ ì£¼ì†Œë¡œ dbì—ì„œ íšŒì› ì •ë³´ë¥¼ ì¡°íšŒí•œ í›„, ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‚œìˆ˜ 6ìë¦¬ë¡œ ì¬ì„¤ì •í•©ë‹ˆë‹¤  
ì‚¬ìš©í•œ ì¿¼ë¦¬ë¬¸ì€ ê°™ì€ ë¬¸ì„œì˜ [**íšŒì› ë¡œê·¸ì¸**](#íšŒì›-ë¡œê·¸ì¸) í•­ëª©ì˜ ìµœí•˜ë‹¨ì— ìˆìŠµë‹ˆë‹¤  
ì´í›„ ìë°” ë©”ì¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì´ìš©í•´ ë§Œë“  EmailUtil í´ë˜ìŠ¤ ê°ì²´ë¥¼ í†µí•´ ë©”ì¼ì„ ì „ì†¡í•˜ê³ ,   
ì„¸ì…˜ì„ ì´ìš©í•´ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ì„ ë„ì›Œì¤ë‹ˆë‹¤  
<br/>

```java
@Component
@RequiredArgsConstructor
public class EmailUtil {
    //ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ë©”ì¼ ì „ì†¡
    public void sendResetPasswordMail(Member member) throws MessagingException, UnsupportedEncodingException {
        MimeMessage message = javaMailSender.createMimeMessage();
        InternetAddress admin = new InternetAddress("noreply@modooary.com");
        admin.setPersonal("modooary");
        message.setFrom(admin);
        message.setRecipients(Message.RecipientType.TO, member.getEmail());
        message.setSubject(member.getName() + "ë‹˜ì˜ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤");

        String content = new StringBuffer().append("<h2>ëª¨ë‘ì–´ë¦¬</h2>")
                .append(member.getName() + "ë‹˜ì˜ ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤<br>")
                .append(member.getPassword() + "<br>")
                .append("ë¡œê·¸ì¸ í›„ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•´ì£¼ì„¸ìš”<br>")
                .append("<a href='http://" + address)
                .append("' target='_blenk'>ëª¨ë‘ì–´ë¦¬ ë°”ë¡œê°€ê¸°</a>")
                .toString();

        message.setText(content, "UTF-8", "html");
        javaMailSender.send(message);
    }
}
```

<br/>
ì‹¤ì œë¡œ ìœ„ ê³¼ì • í›„ ë°œì†¡ëœ ë©”ì¼ì…ë‹ˆë‹¤  
<br/>
<img width="1003" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2021-06-30 á„‹á…©á„’á…® 11 32 40" src="https://user-images.githubusercontent.com/80666066/123979210-7a7d9000-d9fb-11eb-9de0-9ea44d5afc80.png">

<br/>
<hr>
<br/><br/>

### ğŸ“¡ajaxë¥¼ ì´ìš©í•´ DB ì¡°íšŒ ê²°ê³¼ ë°˜í™˜ë°›ê¸°  

ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ë°œê¸‰ ì‹œ, ë¡œê·¸ì¸ ë•Œì™€ ë™ì¼í•˜ê²Œ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í•˜ëŠ” ë™ì‹œì—  
ì¶”ê°€ì ìœ¼ë¡œ ajax í†µì‹ ì„ í†µí•´ í•´ë‹¹ ì´ë©”ì¼ì´ ê°€ì…ëœ ì´ë©”ì¼ì¸ì§€ë„ í™•ì¸í•©ë‹ˆë‹¤  
<br/>

```javascript
//ê°€ì…ëœ ë©”ì¼ì¸ì§€ í™•ì¸
//ê°€ì…í•œ ë©”ì¼ì´ë©´ true, ì•„ë‹ˆë©´ false ë°˜í™˜
function checkEmailMember(email) {
    let data = {'email' : email};
    let checkResult = false;

    $.ajax({
        url: '/reset-password/check-email',
        data: data,
        type: 'post',
        async: false,
        success: function (result){
            if(result){
                checkResult = true;
            }else{
                document.getElementById('reset-password-email-error').innerHTML = 'ì•„ì§ ê°€ì…í•˜ì§€ ì•Šì€ ë©”ì¼ì…ë‹ˆë‹¤';
                document.getElementById('reset-password-email-error').style.display = 'inline';
            }
        }
    })

    return checkResult;
}
```

<br/>
postí˜•ì‹ìœ¼ë¡œ ì´ë©”ì¼ ê°’ì„ ë„˜ê²¨ì£¼ë©´, ì„œë²„ë‹¨ì—ì„œ dbë¥¼ ì¡°íšŒí•´ í•´ë‹¹ ë©”ì¼ì´ ìˆëŠ”ì§€ ì—¬ë¶€ë¥¼ booleaní˜•ìœ¼ë¡œ ë°˜í™˜í•´ì¤ë‹ˆë‹¤  
<br/>  

```java
//ë“±ë¡ëœ íšŒì›ì¸ì§€ ì´ë©”ì¼ë¡œ íšì¸
@PostMapping("/reset-password/check-email")
@ResponseBody
public boolean checkEmailMember(HttpServletRequest request) {
    //ë“±ë¡ëœ íšŒì›ì´ë©´ trueë¥¼, ì•„ë‹ˆë©´ falseë¥¼ ë°˜í™˜
    String email = request.getParameter("email");
    return !(memberService.checkEmailUsable(email));
}
```

<br/>
checkEmailUsable ë©”ì†Œë“œëŠ” íšŒì›ê°€ì… ë•Œ ì´ë©”ì¼ ì¤‘ë³µ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ ì‘ì„±í–ˆë˜ ë©”ì†Œë“œì…ë‹ˆë‹¤  
ë ˆí¬ì§€í† ë¦¬ í´ë˜ìŠ¤ë¥¼ í†µí•´ ì‹¤í–‰ë˜ëŠ” ì¿¼ë¦¬ë¬¸ì€ ê²°ê³¼ì ìœ¼ë¡œ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤  
<br/>

```java
@Repository
@RequiredArgsConstructor
public class MemberRepository {
    private final EntityManager em;
    
    //ì¤‘ë³µë˜ëŠ” ì´ë©”ì¼ì´ ìˆëŠ”ì§€ ê²€ì‚¬
    public boolean checkEmail(String email) {
        try{
            Member member = em.createQuery("select m from Member m" + "" +
                    " where m.email = :email", Member.class)
                    .setParameter("email", email)
                    .getSingleResult();
        }catch (NoResultException e) {
            return true;
        }
        return false;
    }
}
```  

<br/>  

ì…ë ¥ëœ ì´ë©”ì¼ì´ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ í†µí•´ DB íšŒì› í…Œì´ë¸”ì—ì„œ ì¡°íšŒê°€ ë  ë•Œë§Œ í¼ ì œì¶œì´ ë©ë‹ˆë‹¤  


